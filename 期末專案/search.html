<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é€²éšæŸ¥è©¢ - åŒ…è£¹è¿½è¹¤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eff6ff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 24px 28px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      color: #111827;
    }
    .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: #6b7280;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      font-size: 13px;
      color: #4b5563;
    }
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
      color: #3730a3;
      margin-left: 6px;
    }
    .btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-outline {
      background: #fff;
      color: #2563eb;
      border: 1px solid #2563eb;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      background: #10b981;
      color: #fff;
    }
    .btn-danger {
      padding: 4px 10px;
      font-size: 12px;
      background: #ef4444;
      color: #fff;
      margin-left: 4px;
    }
    
    .main-search-row {
      display: flex;
      gap: 12px;
      align-items: flex-end; 
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f3f4f6;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 14px;
      font-size: 13px;
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 140px;
      flex: 1;
    }
    label {
      margin-bottom: 4px;
      color: #4b5563;
      font-weight: bold;
      font-size: 12px;
    }
    input {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background: #f3f4f6;
      color: #374151;
    }
    tr:nth-child(even) td {
      background: #fafafa;
    }
    
    option:disabled {
        color: #d1d5db; 
        background-color: #f3f4f6;
    }

    #notLoginBox {
      padding: 40px 20px;
      text-align: center;
      color: #4b5563;
      font-size: 14px;
    }
    #notLoginBox button {
      margin-top: 12px;
    }
    
    /* æ­·å²å½ˆçª—æ¨£å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .close {
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .timeline {
      position: relative;
      padding-left: 30px;
    }
    .timeline-item {
      position: relative;
      padding-bottom: 20px;
      border-left: 2px solid #e5e7eb;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2563eb;
    }
    .timeline-content {
      padding-left: 20px;
    }
    .timeline-time {
      font-size: 12px;
      color: #9ca3af;
    }
    .timeline-status {
      font-weight: bold;
      color: #111827;
    }
    .timeline-desc {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-bar">
      <div>
        ç™»å…¥å¸³è™Ÿ:<span id="currentUser">(è¼‰å…¥ä¸­)</span>
        <span id="currentRole" class="badge"></span>
      </div>
      <div>
        <button class="btn btn-secondary" type="button" onclick="goParcel()">è¿”å›å„²å­˜åŒ…è£¹</button>
        <button id="btnDownload" class="btn btn-outline" type="button" onclick="downloadExcel()">
          ä¸‹è¼‰æ—¥èªŒ (.xlsx)
        </button>
        <button class="btn btn-secondary" type="button" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <h1>é€²éšæŸ¥è©¢ - åŒ…è£¹è¿½è¹¤</h1>
    <p class="subtitle">
      å¯ä¾è¿½è¹¤ç·¨è™Ÿã€å¯„ä»¶äººå¸³è™Ÿæˆ–æ—¥æœŸå€é–“ç¯©é¸åŒ…è£¹è³‡æ–™
    </p>

    <div id="notLoginBox" style="display:none;">
      æ‚¨å°šæœªç™»å…¥,ç„¡æ³•æŸ¥è©¢åŒ…è£¹è³‡æ–™ã€‚<br>
      è«‹å…ˆå›ç™»å…¥é é¢å®Œæˆç™»å…¥å¾Œ,å†é‡æ–°é–‹å•Ÿæ­¤é ã€‚
      <br>
      <button class="btn btn-secondary" type="button" onclick="goLogin()">å‰å¾€ç™»å…¥é </button>
    </div>

    <div id="searchArea" style="display:none;">
      
      <div class="main-search-row">
        <div class="filter-group" style="flex: 2;">
          <label for="filterTracking" style="font-size: 14px; color: #111827;">ğŸ” å¿«é€Ÿæœå°‹ï¼šè¿½è¹¤ç·¨è™Ÿ</label>
          <input id="filterTracking" placeholder="è¼¸å…¥ TRK- é–‹é ­çš„ç·¨è™Ÿ" oninput="applyFilter(false)" style="padding: 10px;">
        </div>
        <button class="btn btn-primary" style="height: 38px; padding: 0 30px;" onclick="applyFilter(true)">æœå°‹</button>
      </div>

      <div class="filter-row">
        <div class="filter-group">
          <label for="filterSender">å¯„ä»¶äººå¸³è™Ÿ</label>
          <input id="filterSender" placeholder="ä¾‹å¦‚:test1" oninput="applyFilter(false)">
        </div>

        <div class="filter-group">
          <label for="filterVehicle">é‹è¼¸è¼‰å…· ID</label>
          <input id="filterVehicle" placeholder="ä¾‹å¦‚: TRUCK-01">
        </div>
        <div class="filter-group">
          <label for="filterWarehouse">å€‰å„²åœ°é» ID</label>
          <input id="filterWarehouse" placeholder="ä¾‹å¦‚: WH-KS">
        </div>

        <div class="filter-group">
          <label for="filterDateFrom">å¯„ä»¶æ—¥æœŸ(èµ·)</label>
          <input id="filterDateFrom" type="date" onchange="applyFilter(false)">
        </div>
        <div class="filter-group">
          <label for="filterDateTo">å¯„ä»¶æ—¥æœŸ(è¿„)</label>
          <input id="filterDateTo" type="date" onchange="applyFilter(false)">
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>è¿½è¹¤ç·¨è™Ÿ</th>
            <th>å¯„ä»¶äººå¸³è™Ÿ</th>
            <th>æ”¶ä»¶äººå§“å</th>
            <th>æ”¶ä»¶åœ°å€</th>
            <th>é‡é‡</th>
            <th>åŒ…è£¹é¡å‹</th>
            <th>å¯„ä»¶æ—¥æœŸ</th>
            <th>é‡‘é¡</th>
            <th>ç‹€æ…‹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordBody">
        </tbody>
      </table>

    </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">ç‰©æµæ­·å²</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div id="historyContent" class="timeline">
        </div>
    </div>
  </div>

<script>
  const API_BASE = "http://127.0.0.1:5000";
  let allRecords = [];
  let currentRole = "customer";

  function logout() {
    localStorage.clear();
    alert("å·²ç™»å‡º");
    window.location.href = "login.html";
  }

  function goParcel() {
    window.location.href = "parcel_tracking.html";
  }

  function goLogin() {
    window.location.href = "login.html";
  }

  async function initPage() {
    const token = localStorage.getItem("jwt_token");
    const username = localStorage.getItem("username") || "(æœªç™»å…¥)";
    currentRole = localStorage.getItem("role") || "guest";

    const notLoginBox = document.getElementById("notLoginBox");
    const searchArea = document.getElementById("searchArea");
    const btnDownload = document.getElementById("btnDownload");

    document.getElementById("currentUser").textContent = username;
    document.getElementById("currentRole").textContent =
      currentRole === "admin" ? "ç®¡ç†äººå“¡" :
      currentRole === "staff" ? "ä½œæ¥­äººå“¡" :
      currentRole === "driver" ? "é§•é§›å“¡" :
      currentRole === "warehouse" ? "å€‰å„²äººå“¡" :
      currentRole === "customer" ? "å®¢æˆ¶" : "æœªç™»å…¥";

    notLoginBox.style.display = "none";
    searchArea.style.display = "none";
    btnDownload.style.display = "none";

    if (!token) {
      notLoginBox.style.display = "block";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/records`,{
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}` 
        }
      });
      const result = await res.json();
     
      if (!res.ok) {
        if (res.status === 401) {
            alert("ç™»å…¥å·²éæœŸ,è«‹é‡æ–°ç™»å…¥");
            logout();
            return;
        }
        alert("è¼‰å…¥åŒ…è£¹è³‡æ–™å¤±æ•—:" + (result.error || res.status));
      } else {
        allRecords = result || [];
      }
    } catch (err) {
      console.error(err);
      alert("è¼‰å…¥åŒ…è£¹è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
    }

    searchArea.style.display = "block";

    if (["staff", "admin", "driver", "warehouse"].includes(currentRole)) {
      btnDownload.style.display = "inline-block";
    }

    applyFilter(false);
  }

  const NORMAL_FLOW = [
      "å»ºç«‹åŒ…è£¹",
      "å·²æ”¶ä»¶",
      "é€²å…¥å€‰å„²",
      "å·²è£è»Š",
      "é…é€ä¸­",
      "å·²é€é”",
      "å·²ç°½æ”¶"
  ];

  const ABNORMAL_STATUSES = [
      "å»¶èª¤", "éºå¤±", "ææ¯€", "é€€å›"
  ];

  const STATUS_OPTIONS = [
    ...NORMAL_FLOW,
    "---ç•°å¸¸ç‹€æ…‹---",
    ...ABNORMAL_STATUSES
  ];

  const STATUS_ORDER = {};
  NORMAL_FLOW.forEach((s, i) => { STATUS_ORDER[s] = i + 1; });
  ABNORMAL_STATUSES.forEach((s, i) => { STATUS_ORDER[s] = 90 + i; });

  const ROLE_STATUS_MAP = {
      "driver": ["å·²è£è»Š", "é…é€ä¸­", "å·²é€é”", "å·²ç°½æ”¶", ...ABNORMAL_STATUSES],
      "warehouse": ["å·²æ”¶ä»¶", "é€²å…¥å€‰å„²", "å·²è£è»Š", "é€€å›", ...ABNORMAL_STATUSES],
      "staff": null, 
      "admin": null
  };

  function canEditStatus() {
    return currentRole !== "customer" && currentRole !== "guest";
  }

  function escapeHtml(str) {
    return (str || "").replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderStatusCell(tracking, currentStatus) {
    const safeTracking = encodeURIComponent(tracking);
    const safeCurrent = (currentStatus || "").trim();
    const isAdmin = currentRole === "admin"; 

    if (!canEditStatus()) {
      return `<span>${escapeHtml(safeCurrent || "-")}</span>`;
    }

    const roleAllowed = ROLE_STATUS_MAP[currentRole];
    const isCurrentAbnormal = ABNORMAL_STATUSES.includes(safeCurrent);
    
    // åªæœ‰ç•¶ (éç®¡ç†å“¡) ä¸” (ç›®å‰æ˜¯ç•°å¸¸ç‹€æ…‹) æ™‚ï¼Œæ‰é–ä½
    const isLocked = !isAdmin && isCurrentAbnormal;
    const disabledAttr = isLocked ? "disabled" : "";

    let sequenceAllowed = [];
    if (NORMAL_FLOW.includes(safeCurrent)) {
        const idx = NORMAL_FLOW.indexOf(safeCurrent);
        sequenceAllowed.push(safeCurrent);
        if (idx < NORMAL_FLOW.length - 1) {
            sequenceAllowed.push(NORMAL_FLOW[idx + 1]);
        }
        sequenceAllowed.push(...ABNORMAL_STATUSES);
    } else {
        sequenceAllowed = [...NORMAL_FLOW, ...ABNORMAL_STATUSES];
    }

    const opts = STATUS_OPTIONS.map(s => {
      if (s.includes("---")) {
          return `<option disabled>${s}</option>`;
      }

      const selected = s === safeCurrent ? "selected" : "";
      
      let isRoleForbidden = false;
      if (!isAdmin && roleAllowed && !roleAllowed.includes(s)) {
          isRoleForbidden = true;
      }
      
      let isSequenceForbidden = false;
      if (!isAdmin) {
          if (!sequenceAllowed.includes(s) && s !== safeCurrent) {
              isSequenceForbidden = true;
          }
      }

      const isDisabled = isRoleForbidden || isSequenceForbidden;
      const disabledStr = isDisabled ? "disabled" : "";
      
      return `<option value="${escapeHtml(s)}" ${selected} ${disabledStr}>${escapeHtml(s)}</option>`;
    }).join("");

    return `
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="st_${safeTracking}" ${disabledAttr} style="padding:4px 6px; border-radius:8px; border:1px solid #d1d5db; font-size:13px;">
          ${opts}
        </select>
        <button class="btn btn-secondary" ${disabledAttr} type="button" onclick="updateStatus('${escapeHtml(tracking)}')">æ›´æ–°</button>
      </div>
    `;
  }

  async function updateStatus(tracking) {
    if (!canEditStatus()) {
      alert("æ¬Šé™ä¸è¶³:å®¢æˆ¶ç„¡æ³•ä¿®æ”¹åŒ…è£¹ç‹€æ…‹");
      return;
    }

    const token = localStorage.getItem("jwt_token");
    if (!token) {
      alert("å°šæœªç™»å…¥");
      return;
    }

    const sel = document.getElementById(`st_${encodeURIComponent(tracking)}`);
    if (!sel) return;

    // âœ… å–å¾—åŸæœ¬çš„ç‹€æ…‹ (ç”¨æ–¼å–æ¶ˆæ™‚å¾©åŸ)
    const currentRecord = allRecords.find(r => r.tracking_no == tracking);
    const originalStatus = currentRecord ? currentRecord.status : "";

    // âœ… å®šç¾©å¾©åŸå‡½å¼
    const revertSelection = () => {
        if(sel && originalStatus) sel.value = originalStatus;
    };

    const newStatus = (sel.value || "").trim();
    if (!newStatus || newStatus.includes("---")) {
      alert("è«‹é¸æ“‡æœ‰æ•ˆç‹€æ…‹");
      revertSelection();
      return;
    }

    // 1. åœ°é» (å–æ¶ˆå‰‡å¾©åŸ)
    const location = prompt(`æ­£åœ¨æ›´æ–°å–®è™Ÿ ${tracking} ç‚º '${newStatus}'\nè«‹è¼¸å…¥ç›®å‰åœ°é» (å¿…å¡«):`, "è½‰é‹ä¸­å¿ƒ");
    if (location === null) {
        revertSelection(); // ğŸ‘ˆ å¾©åŸ
        return; 
    }

    // 2. è¼‰å…· (å–æ¶ˆå‰‡å¾©åŸ)
    let vehicleId = "";
    if (newStatus.includes("è£è»Š") || newStatus.includes("é…é€")) {
        const vInput = prompt("è«‹è¼¸å…¥é‹è¼¸è¼‰å…· ID (ä¾‹å¦‚: TRUCK-01):", "");
        if (vInput === null) {
             revertSelection(); // ğŸ‘ˆ å¾©åŸ
             return;
        }
        vehicleId = vInput;
    }

    // 3. å€‰å„² (å–æ¶ˆå‰‡å¾©åŸ)
    let warehouseId = "";
    if (newStatus.includes("å€‰å„²") || newStatus.includes("æ”¶ä»¶")) {
        const wInput = prompt("è«‹è¼¸å…¥å€‰å„² ID (ä¾‹å¦‚: WH-01):", "");
        if (wInput === null) {
            revertSelection(); // ğŸ‘ˆ å¾©åŸ
            return;
        }
        warehouseId = wInput;
    }

    // 4. å‚™è¨» (å–æ¶ˆå‰‡å¾©åŸ)
    const dInput = prompt("å‚™è¨» (é¸å¡«):", "");
    if (dInput === null) {
        revertSelection(); // ğŸ‘ˆ å¾©åŸ
        return;
    }
    const description = dInput;

    try {
      const res = await fetch(`${API_BASE}/api/parcels/status`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ 
          tracking_number: tracking, 
          status: newStatus,
          location: location,
          vehicle_id: vehicleId,
          warehouse_id: warehouseId,
          description: description
        }),
      });

      const result = await res.json();
      if (!res.ok) {
        alert("æ›´æ–°ç‹€æ…‹å¤±æ•—:" + (result.error || res.status));
        revertSelection(); // å¤±æ•—ä¹Ÿå¾©åŸ
        return;
      }

      alert("ç‹€æ…‹æ›´æ–°æˆåŠŸï¼");
      
      const targetRecord = allRecords.find(r => r.tracking_no === tracking);
      if (targetRecord) {
          targetRecord.status = newStatus;
      }
      applyFilter(false);

    } catch (err) {
      console.error(err);
      alert("æ›´æ–°ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤");
      revertSelection(); // éŒ¯èª¤ä¹Ÿå¾©åŸ
    }
  }

  function sortRecords(records) {
    return records.sort((a, b) => {
        const statusA = a.status || "";
        const statusB = b.status || "";
        
        const weightA = STATUS_ORDER[statusA] || 50;
        const weightB = STATUS_ORDER[statusB] || 50;

        if (weightA !== weightB) {
            return weightA - weightB; 
        }
        
        if (a.tracking_no > b.tracking_no) return -1;
        if (a.tracking_no < b.tracking_no) return 1;
        return 0;
    });
  }

  async function applyFilter(forceBackend = false) {
    const t = document.getElementById("filterTracking").value.trim().toLowerCase();
    const s = document.getElementById("filterSender").value.trim().toLowerCase();
    const dFrom = document.getElementById("filterDateFrom").value;
    const dTo = document.getElementById("filterDateTo").value;
    
    const v = document.getElementById("filterVehicle").value.trim();
    const w = document.getElementById("filterWarehouse").value.trim();

    if (forceBackend || v || w) {
        const token = localStorage.getItem("jwt_token");
        const params = new URLSearchParams();
        if (v) params.append("vehicle_id", v);
        if (w) params.append("warehouse_id", w);

        try {
            const res = await fetch(`${API_BASE}/records?${params.toString()}`, {
                method: "GET",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                }
            });
            if (res.ok) {
                allRecords = await res.json();
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    const sortedRecords = sortRecords([...allRecords]); 

    const tbody = document.getElementById("recordBody");
    tbody.innerHTML = "";

    sortedRecords.forEach(r => {
      const tracking = (r.tracking_no || "").toString();
      const sender = (r.sender_id || "").toString();
      const name = r.receiver_name || "";
      const address = r.recipient_address || "";
      const weight = r.weight || "";
      const packageType = r.package_type || "";
      const date = r.date || "";
      const amount = (r.amount !== null && r.amount !== undefined) ? r.amount : "";
      const status = (r.status !== null && r.status !== undefined) ? (r.status + "") : "";

      if (t && !tracking.toLowerCase().includes(t)) return;
      if (s && !sender.toLowerCase().includes(s)) return;
      if (dFrom && (!date || date < dFrom)) return;
      if (dTo && (!date || date > dTo)) return;

      const deleteBtn = (currentRole === "admin" || currentRole === "staff") 
        ? `<button class="btn btn-danger" onclick="deleteParcel('${tracking}')">åˆªé™¤</button>` 
        : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${tracking}</td>
        <td>${sender}</td>
        <td>${name}</td>
        <td>${address}</td>
        <td>${weight}</td>
        <td>${packageType}</td>
        <td>${date}</td>
        <td>${amount}</td>
        <td>${renderStatusCell(tracking, status)}</td>
        <td>
          <button class="btn btn-small" onclick="viewHistory('${tracking}')">æŸ¥çœ‹æ­·å²</button>
          ${deleteBtn}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function deleteParcel(tracking) {
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤åŒ…è£¹ ${tracking} å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
    
    const token = localStorage.getItem("jwt_token");
    try {
        const res = await fetch(`${API_BASE}/api/parcels/${tracking}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if(res.ok) {
            alert("åˆªé™¤æˆåŠŸ");
            allRecords = allRecords.filter(p => p.tracking_no !== tracking);
            applyFilter(false); 
        } else {
            const data = await res.json();
            alert("åˆªé™¤å¤±æ•—: " + (data.error || res.status));
        }
    } catch(e) {
        console.error(e);
        alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
    }
  }

  async function viewHistory(trackingNo) {
    const token = localStorage.getItem("jwt_token");
    if (!token) {
      alert("å°šæœªç™»å…¥");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/parcels/${trackingNo}/history`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      });

      const result = await res.json();

      if (!res.ok) {
        alert("æŸ¥è©¢æ­·å²å¤±æ•—:" + (result.error || res.status));
        return;
      }

      showHistoryModal(trackingNo, result.events || []);

    } catch (err) {
      console.error(err);
      alert("æŸ¥è©¢æ­·å²æ™‚ç™¼ç”ŸéŒ¯èª¤");
    }
  }

  function showHistoryModal(trackingNo, events) {
    document.getElementById("modalTitle").textContent = `ç‰©æµæ­·å² - ${trackingNo}`;
    
    const content = document.getElementById("historyContent");
    content.innerHTML = "";

    if (events.length === 0) {
      content.innerHTML = "<p style='color:#9ca3af;'>ç›®å‰ç„¡ç‰©æµäº‹ä»¶ç´€éŒ„</p>";
    } else {
      events.forEach(e => {
        let descHtml = "";
        
        if (currentRole === "customer") {
            descHtml = `
              ${e.location ? `åœ°é»: ${e.location}<br>` : ""}
              ${e.description ? `å‚™è¨»: ${e.description}` : ""}
            `;
        } else {
            descHtml = `
              ${e.location ? `åœ°é»: ${e.location}<br>` : ""}
              ${e.vehicle_id ? `è»Šè¼›: ${e.vehicle_id}<br>` : ""}
              ${e.warehouse_id ? `å€‰å„²: ${e.warehouse_id}<br>` : ""}
              ${e.operator ? `æ“ä½œäººå“¡: ${e.operator}<br>` : ""}
              ${e.description ? `å‚™è¨»: ${e.description}` : ""}
            `;
        }

        const item = document.createElement("div");
        item.className = "timeline-item";
        item.innerHTML = `
          <div class="timeline-content">
            <div class="timeline-time">${e.timestamp || ""}</div>
            <div class="timeline-status">${e.event_type || ""}</div>
            <div class="timeline-desc">
              ${descHtml}
            </div>
          </div>
        `;
        content.appendChild(item);
      });
    }

    document.getElementById("historyModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("historyModal").style.display = "none";
  }

  window.onclick = function(event) {
    const modal = document.getElementById("historyModal");
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  async function downloadExcel() {
    try {
      const token = localStorage.getItem("jwt_token");
      if (!token) {
        alert("å°šæœªç™»å…¥");
        return;
      }
      
      const btn = document.getElementById("btnDownload");
      const originalText = btn.innerText;
      btn.innerText = "ä¸‹è¼‰ä¸­...";
      btn.disabled = true;

      const res = await fetch(`${API_BASE}/api/download`, {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` },
      });
      
      if (!res.ok) {
        alert("ä¸‹è¼‰å¤±æ•—");
        btn.innerText = originalText;
        btn.disabled = false;
        return;
      }
      
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "logistics_full_data.xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      
      btn.innerText = originalText;
      btn.disabled = false;

    } catch (err) {
      console.error(err);
      alert("ä¸‹è¼‰éŒ¯èª¤");
      document.getElementById("btnDownload").innerText = "ä¸‹è¼‰æ—¥èªŒ (.xlsx)";
      document.getElementById("btnDownload").disabled = false;
    }
  }

  window.addEventListener("load", initPage);
</script>
</body>
</html>